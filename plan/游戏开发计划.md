# 植物大战僵尸 SPA 游戏 - 实现计划

## Context
复刻一个植物大战僵尸小游戏，部署到 Cloudflare Pages。使用 React + Canvas + Vite + TypeScript 技术栈，使用 `public/` 目录下的现成图片/音频素材（GIF 动画 + PNG 静态图），支持桌面和移动端。

---

## 技术架构

- **React** 负责：主菜单、关卡选择、植物选择、暂停弹窗、胜负结果等 UI
- **Canvas** 负责：游戏区域渲染（草地、植物、僵尸、子弹、阳光等）
- **EventBus** 作为 React 和游戏引擎之间的唯一通信桥梁
- **背景音乐** 使用 `public/Grazy Dave.mp3`（HTML5 Audio 播放）
- **Web Audio API** 合成基础音效（点击、放置等交互音效）
- **localStorage** 存档进度

---

## 游戏内容

### 植物（7种）
| 植物 | 费用 | HP | 冷却 | 行为 | 素材 |
|------|------|----|------|------|------|
| 向日葵 | 50 | 300 | 7.5s | 每24s产25阳光 | `SunFlower.gif`(动画) / `SunFlower.png`(卡面) |
| 豌豆射手 | 100 | 300 | 7.5s | 每1.4s射1颗豌豆(20伤害) | `Peashooter.gif`(动画) / `Peashooter.png`(卡面) |
| 坚果墙 | 50 | 4000 | 30s | 纯肉盾，有破损视觉状态 | `WallNut.gif`(满血) / `WallNut1.gif`(损伤) / `WallNut2.gif`(重伤) / `WallNut.png`(卡面) |
| 寒冰射手 | 175 | 300 | 7.5s | 每1.4s射冰豌豆(20伤害+50%减速3s) | `SnowPea.gif`(动画) / `SnowPea.png`(卡面) |
| 樱桃炸弹 | 150 | - | 50s | 3x3范围1800伤害，一次性 | `CherryBomb.gif`(爆炸动画) / `CherryBomb.png`(卡面) |
| 双发射手 | 200 | 300 | 7.5s | 每1.4s射2颗豌豆 | `Repeater.gif`(动画) / `Repeater.png`(卡面) |
| 土豆地雷 | 25 | 300 | 30s | 15s后激活，踩中1800伤害 | `PotatoMine1.gif`(未激活) / `PotatoMine.gif`(激活) / `PotatoMineBomb.gif`(爆炸) / `PotatoMine.png`(卡面) |

> **注意：** 移除了食人花（无对应素材）。

### 僵尸（5种）
| 僵尸 | HP | 护甲 | 速度 | 特殊能力 | 素材 |
|------|----|------|------|---------|------|
| 普通僵尸 | 200 | 0 | 15px/s | 无 | `ZombieWalk1.gif`/`ZombieWalk2.gif`(行走) / `ZombieAttack.gif`(攻击) / `ZombieDie.gif`(死亡) / `ZombieHead.gif`(掉头) |
| 路障僵尸 | 200 | 370 | 15px/s | 路障吸收伤害 | `ConeZombieWalk.gif`(行走) / `ConeZombieAttack.gif`(攻击) |
| 铁桶僵尸 | 200 | 1100 | 15px/s | 铁桶吸收大量伤害 | `BucketZombieWalk.gif`(行走) / `BucketZombieAttack.gif`(攻击) |
| 撑杆僵尸 | 200 | 0 | 30→15px/s | 跳过第一个植物 | `ScreenZombieWalk.gif`(行走) / `ScreenZombieAttack.gif`(攻击) |
| 橄榄球僵尸 | 200 | 1400 | 25px/s | 高护甲高速冲锋 | `FootballZombieWalk.gif`(行走) / `FootballZombieAttack.gif`(攻击) / `FootballZombieDie.gif`(死亡) |

> **注意：** 根据实际素材，用橄榄球僵尸替换了报纸僵尸。

### 5个关卡（渐进解锁）
- 第1关：向日葵+豌豆射手 vs 普通僵尸（3波）
- 第2关：+坚果墙+寒冰射手 vs +路障僵尸（4波）
- 第3关：+樱桃炸弹+土豆地雷 vs +铁桶僵尸（5波）
- 第4关：+双发射手 vs +撑杆僵尸（6波）
- 第5关：全植物 vs +橄榄球僵尸（8波，最终大战）

### 通用 UI/特效素材
| 素材 | 用途 |
|------|------|
| `Background.jpg` | 游戏场景草地背景 |
| `Card.png` | 植物卡牌背景框 |
| `Shop.png` | 顶部卡槽栏背景 |
| `Button.png` | 通用按钮素材 |
| `Shovel.png` | 铲子图标 |
| `ShovelBank.png` | 铲子槽位背景 |
| `LawnMower.png` | 割草机（最后防线） |
| `Sun.gif` | 阳光动画 |
| `Pea.png` | 豌豆子弹 |
| `PeaSnow.png` | 冰豌豆子弹 |
| `Boom.gif` | 爆炸特效 |
| `Burn.gif` | 燃烧特效 |
| `ZombiesWon.png` | 僵尸获胜画面 |
| `Grazy Dave.mp3` | 背景音乐 |

---

## 项目目录结构

```
plantvszombie/
├── index.html
├── package.json
├── vite.config.ts
├── tsconfig.json
├── src/
│   ├── main.tsx                     # React 入口
│   ├── App.tsx                      # 根组件，屏幕路由
│   ├── engine/                      # 纯游戏引擎（不依赖 React）
│   │   ├── Game.ts                  # 游戏循环、状态机
│   │   ├── World.ts                 # 实体容器、查询
│   │   ├── Entity.ts                # 实体类
│   │   ├── systems/                 # 系统管线
│   │   │   ├── SpawnSystem.ts       # 天空阳光、僵尸波次生成
│   │   │   ├── WaveSystem.ts        # 波次进度、胜负判定
│   │   │   ├── PlantBehaviorSystem.ts
│   │   │   ├── ZombieBehaviorSystem.ts
│   │   │   ├── ProjectileSystem.ts
│   │   │   ├── MovementSystem.ts
│   │   │   ├── CollisionSystem.ts
│   │   │   ├── CombatSystem.ts
│   │   │   ├── SunSystem.ts
│   │   │   └── CleanupSystem.ts
│   │   └── events/
│   │       └── EventBus.ts          # 发布-订阅通信
│   ├── data/                        # 静态数据
│   │   ├── plants.ts
│   │   ├── zombies.ts
│   │   └── levels.ts
│   ├── renderer/                    # Canvas 渲染层
│   │   ├── Renderer.ts
│   │   ├── Camera.ts                # 视口缩放、坐标转换
│   │   ├── layers/
│   │   │   ├── BackgroundLayer.ts
│   │   │   ├── EntityLayer.ts
│   │   │   └── EffectLayer.ts
│   │   └── assets/                  # 素材加载与管理
│   │       ├── AssetLoader.ts       # 预加载所有图片/GIF/音频
│   │       ├── GifDecoder.ts        # GIF 帧解析（逐帧绘制到 Canvas）
│   │       └── AssetMap.ts          # 素材路径映射表
│   ├── audio/
│   │   └── AudioManager.ts         # 背景音乐(mp3) + Web Audio API 合成交互音效
│   ├── ui/                          # React UI
│   │   ├── screens/
│   │   │   ├── MainMenu.tsx
│   │   │   ├── LevelSelect.tsx
│   │   │   ├── PlantSelect.tsx
│   │   │   ├── GameScreen.tsx
│   │   │   ├── PauseOverlay.tsx
│   │   │   └── ResultScreen.tsx
│   │   ├── components/
│   │   │   ├── PlantCard.tsx
│   │   │   ├── SunCounter.tsx
│   │   │   ├── Toolbar.tsx
│   │   │   ├── ShovelButton.tsx
│   │   │   └── ProgressBar.tsx
│   │   └── hooks/
│   │       ├── useGameEngine.ts     # 核心 Hook：创建 Game/Renderer 实例
│   │       ├── useCanvasResize.ts
│   │       └── useAudio.ts
│   ├── save/
│   │   └── SaveManager.ts          # localStorage 存档
│   ├── utils/
│   │   ├── math.ts
│   │   ├── collision.ts
│   │   └── constants.ts            # 画布尺寸、网格参数
│   └── types/
│       ├── index.ts
│       └── enums.ts
└── tests/                           # Vitest 测试
```

---

## 核心架构设计

### 游戏循环（固定时间步长）
- 逻辑更新：60Hz 固定时间步长，保证确定性
- 渲染：可变帧率，用插值因子平滑

### 实体-组件模型（轻量级）
- Entity：唯一 ID + 类型标签 + 组件 Map
- 组件：纯数据对象（Transform、Health、GridPosition、Movement、Combat 等）
- 系统：每帧按固定顺序执行的函数

### 系统执行顺序
1. SpawnSystem → 2. WaveSystem → 3. PlantBehaviorSystem → 4. ZombieBehaviorSystem → 5. ProjectileSystem → 6. MovementSystem → 7. CollisionSystem → 8. CombatSystem → 9. SunSystem → 10. CleanupSystem

### React ↔ Engine 通信
- EventBus 发布-订阅模式
- Engine → React：SUN_CHANGED、STATE_CHANGED、WAVE_PROGRESS 等
- React → Engine：PLACE_PLANT、COLLECT_SUN、PAUSE_TOGGLED、REMOVE_PLANT 等

### 碰撞检测
- 广相：按行分组（PvZ 战斗在同行内发生）
- 窄相：AABB 矩形重叠检测

---

## 实现阶段

### 阶段 1：项目脚手架 + 核心引擎 + 素材系统
- Vite + React + TS 项目初始化
- Entity、World、EventBus 实现
- Game 游戏循环
- **AssetLoader：预加载所有 PNG/GIF/MP3 素材**
- **GifDecoder：将 GIF 解析为逐帧 ImageBitmap 数组，供 Canvas drawImage 使用**
- **AssetMap：集中管理所有素材路径映射**
- Renderer + Camera + BackgroundLayer（使用 `Background.jpg` 作为背景）
- GameScreen + useGameEngine Hook
- 基础 App 路由壳

### 阶段 2：核心玩法（向日葵 + 豌豆射手 + 普通僵尸）
- 常量和网格工具函数
- 向日葵渲染（`SunFlower.gif` 逐帧动画）
- 豌豆射手渲染（`Peashooter.gif` 逐帧动画）
- 普通僵尸渲染（`ZombieWalk1/2.gif` 行走、`ZombieAttack.gif` 攻击、`ZombieDie.gif` 死亡、`ZombieHead.gif` 掉头）
- 豌豆子弹渲染（`Pea.png`）
- 阳光渲染（`Sun.gif` 逐帧动画）
- 所有核心系统实现（Sun、PlantBehavior、ZombieBehavior、Movement、Projectile、Collision、Combat、Cleanup）
- Toolbar（`Shop.png` 背景 + `Card.png` 卡框 + 各植物 `.png` 卡面）
- PlantCard、SunCounter React 组件
- 点击选卡 → 点击放置流程
- 点击收集阳光流程
- **割草机系统（`LawnMower.png`）**

### 阶段 3：其余植物（5种）
- 坚果墙（`WallNut.gif`/`WallNut1.gif`/`WallNut2.gif` 三阶段破损动画）
- 寒冰射手（`SnowPea.gif` + `PeaSnow.png` 冰豌豆子弹）
- 樱桃炸弹（`CherryBomb.gif` 爆炸 + `Boom.gif`/`Burn.gif` 特效）
- 双发射手（`Repeater.gif`）
- 土豆地雷（`PotatoMine1.gif` 未激活 → `PotatoMine.gif` 激活 → `PotatoMineBomb.gif` 爆炸）
- 卡牌冷却显示

### 阶段 4：其余僵尸（4种）
- 路障僵尸（`ConeZombieWalk.gif`/`ConeZombieAttack.gif`）
- 铁桶僵尸（`BucketZombieWalk.gif`/`BucketZombieAttack.gif`）
- 撑杆僵尸（`ScreenZombieWalk.gif`/`ScreenZombieAttack.gif`）+ 跳跃逻辑
- 橄榄球僵尸（`FootballZombieWalk.gif`/`FootballZombieAttack.gif`/`FootballZombieDie.gif`）+ 高速冲锋逻辑
- 护甲系统

### 阶段 5：关卡系统 + 完整游戏流程
- 5个关卡数据配置
- WaveSystem 波次管理
- 胜负判定（`ZombiesWon.png` 失败画面）
- 主菜单、关卡选择、植物选择、暂停、结果屏幕
- SaveManager 存档
- 铲子功能（`Shovel.png` + `ShovelBank.png`）

### 阶段 6：音效 + 打磨 + 移动端适配
- 背景音乐播放（`Grazy Dave.mp3`，HTML5 Audio）
- Web Audio API 合成交互音效（放置、射击、爆炸、收集阳光等）
- GIF 动画帧率优化与平滑
- 移动端触屏适配
- 静音按钮
- 游戏平衡调整

### 阶段 7：测试 + 部署
- Vitest 单元测试（引擎系统、数据验证）
- 集成测试（模拟游戏循环）
- React 组件测试
- Vite build → Cloudflare Pages 部署配置

---

## 验证方案

1. **单元测试**：Vitest 测试所有引擎系统、工具函数、数据有效性
2. **集成测试**：模拟游戏循环，验证完整战斗流程
3. **React 组件测试**：@testing-library/react 测试 UI 交互
4. **手动验收**：
   - 所有素材正确加载（GIF 逐帧动画流畅、PNG 清晰显示）
   - 每种植物功能正确（7种）
   - 每种僵尸行为正确（5种）
   - 5个关卡可通关
   - 割草机最后防线机制正常
   - 存档持久化有效
   - 移动端触屏可用
   - 背景音乐 + 交互音效正常播放/静音
   - `vite build` 产出可直接部署到 Cloudflare Pages
